
## 4️⃣본인확인-표준창 검증결과 요청

>[!summary]   
> 본인확인-표준창으로부터 결과(본인확인 결과 토큰)를 수신하여, 본인확인 서버로 본인확인 토큰에 대한 결과를 요청합니다.
> 본인확인 결과 토큰의 수신 엔드포인트는 **거래 요청 시 `returnUrl`**로 지정한 URL입니다.

#### Step 1. 본인확인 결과 토큰 수신 및 검증결과 요청정보 
- Step 1-1.  표준창은 `Content-Type: application/x-www-form-urlencoded`(일반적) 또는 `text/plain`로 `data=<url-encoded-json>` 형태를 전달할 수 있습니다.  

예시(수신 Raw):
``` text
data=%257B%2522encryptMOKKeyToken%2522%253A%2522FGUD2QG4k%252F ... 8KsyGp2522resultCode%2522%253A%25222000%2522%252C%2522resultMsg%2522%253A%2522success%2522%257D
```

---
#### 샘플은 JAVA로 제공됩니다.
```java
@PostMapping(path = "/mok/std/return", consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE)
public ResponseEntity<String> receiveStdResult(HttpServletRequest request, @RequestParam("data") String data) throws Exception {

	HttpSession session = request.getSession(false);  
	String clientTxId = null;
	// 0) 세션에서 clientTxId 조회(재사용/검증용)  
	if (session != null) {  
		Object v = session.getAttribute("clientTxId");  
		clientTxId = (v != null) ? String.valueOf(v) : null;  
	}  
	if (clientTxId == null) {  
		log.warn("세션에 clientTxId 없음 - 재요청/세션만료");  
	}
	// 1) URL decode
	String decoded = URLDecoder.decode(data, StandardCharsets.UTF_8.name());

	// 2) JSON 파싱
	ObjectMapper mapper = new ObjectMapper();
	Map<String, String> map = mapper.readValue(decoded, Map.class);

	// 3) 필수 필드 확인
	String token = map.get("encryptMOKKeyToken");
	if (token == null) {
		return ResponseEntity.badRequest().body("본인확인 결과 토큰(encryptMOKKeyToken)이 없습니다.");
	}
	
	// 4) MOK(본인확인) 서버로 토큰 전달 → 5초 TTL 내 검증 요청
	//    (동일 요청의 재사용 방지를 위해 clientTxId(세션/DB)와 매핑, 처리 후 즉시 폐기)
	// 비동기 큐/스레드풀 사용 시, 처리 지연으로 TTL 초과하지 않게 주의 (NTP 시간 동기 필수)

	// TODO: 검증 요청 호출 (아래 Step 2 참고)
	
	return ResponseEntity.ok("OK");
}
```

> [!warning] 주의
> 본인확인 검증 결과는 본인확인 결과 토큰 발급 시점으로부터 5초내에 (TTL 5초) 본인확인 결과 요청을 하여야 합니다. 

---
#### Step 2. 본인확인 검증결과 요청

- 본인확인-표준창 검증 결과 요청 URL

| 메서드  | URL                                                       | 환경  |
| ---- | --------------------------------------------------------- | --- |
| POST | https://scert.mobile-ok.com/gui/service/v1/result/request | 개발  |
| POST | https://cert.mobile-ok.com/gui/service/v1/result/request  | 운영  |

---
## 1️⃣요청

#### 헤더

| 이름           | 설명                                                            | 필수  |
| ------------ | ------------------------------------------------------------- | --- |
| Content-Type | Content-Type : application/json; charset=UTF-8  <br>요청 데이터 타입 | O   |
#### 본문

| 이름                 | 타입     | 설명                           | 필수  |
| ------------------ | ------ | ---------------------------- | --- |
| encryptMOKKeyToken | String | 본인확인-표준창으로부터 전달받은 본인확인 결과 토큰 | O   |

---
## 2️⃣응답

#### 본문

| 이름               | 타입     | 설명                                           | 필수  |
| ---------------- | ------ | -------------------------------------------- | --- |
| resultCode       | String | 응답 결과 코드  <br>-"2000" 이면 성공  <br>- 그 외 실패 처리 | O   |
| resultMsg        | String | 실패 시 에러 설명                                   | O   |
| serviceId        | String | 본인확인 이용기관 서비스 ID                             | O   |
| encryptMOKResult | String | 암호화된 본인확인 검증결과 데이터                           | O   |

---
## 예제

#### 요청
``` shell
curl -X POST https://scert.mobile-ok.com/gui/service/v1/result/request \
-H "Content-Type: application/json; charset=UTF-8" \
-d '{
         "encryptMOKKeyToken" : ${encryptMOKKeyToken}
     }'
```
#### 응답 : 성공
```json
{
	"encryptMOKResult" : "ln0XRGPb//+vzabdYpcjjOlmivt8qI … 3eUZgz1jaqUOZRXz8=",
	"resultCode" : "2000",
	"serviceId" : "690a6a66-2d ... 900d-43f29",
	"resultMsg" : "success"
}
```
