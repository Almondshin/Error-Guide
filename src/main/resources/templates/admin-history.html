<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ì§„ë‹¨ íˆìŠ¤í† ë¦¬ - MOK Error Agent</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f4f7f6; font-family: 'Pretendard', sans-serif; padding-top: 70px; }
        .container { max-width: 1200px; }
        .card { border: none; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .table thead { background-color: #f8f9fa; }
        .navbar { background-color: #1e293b !important; }
        .navbar-brand, .nav-link { color: rgba(255,255,255,0.9) !important; }
        .nav-link.active { color: #fff !important; font-weight: bold; border-bottom: 2px solid #fff; }
        .nav-link:hover { color: #fff !important; }

        /* Table Refinement */
        .history-table {
            table-layout: fixed;
            width: 100%;
        }
        .history-table th, .history-table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .col-date { width: 180px; }
        .col-code { width: 120px; font-weight: bold; }
        .col-context { width: 15%; }
        .col-report { width: auto; }
        .col-action { width: 200px; }

        .btn-group-nowrap {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: nowrap;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg fixed-top shadow-sm mb-4">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/dashboard">MOK Error Agent</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-item nav-link" href="/dashboard">ğŸ” ì‹¤ì‹œê°„ ì§„ë‹¨</a>
            <a class="nav-item nav-link" href="/admin/management">ğŸ“– ì—ëŸ¬ì½”ë“œ ê´€ë¦¬</a>
            <a class="nav-item nav-link" href="/admin/cases">ğŸ’¡ í•´ê²° ì‚¬ë¡€ ì €ì¥ì†Œ</a>
            <a class="nav-item nav-link active" href="/admin/history">ğŸ“œ ì§„ë‹¨ íˆìŠ¤í† ë¦¬</a>
        </div>
    </div>
</nav>

<div class="container py-4">
    <h2 class="fw-bold mb-4">ğŸ“œ ì§„ë‹¨ íˆìŠ¤í† ë¦¬</h2>

    <div class="card p-4">
        <div class="table-responsive">
            <table class="table table-hover align-middle history-table">
                <thead>
                    <tr>
                        <th class="col-date">ë‚ ì§œ</th>
                        <th class="col-code">ì—ëŸ¬ì½”ë“œ</th>
                        <th class="col-context">ê¸°ìˆ  ë§¥ë½</th>
                        <th class="col-report">AI ë³´ê³ ì„œ</th>
                        <th class="text-center col-action">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="history : ${histories}" th:id="'history-row-' + ${history.id}">
                        <td th:text="${#temporals.format(history.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                        <td><span class="badge bg-primary" th:text="${history.errorCode}"></span></td>
                        <td th:title="${history.description}" th:text="${history.description}"></td>
                        <td th:title="${history.aiReport}" th:text="${#strings.abbreviate(history.aiReport, 100)}"></td>
                        <td class="text-center">
                            <div class="btn-group-nowrap">
                                <button class="btn btn-sm btn-info text-white" th:onclick="'showDetail(' + ${history.id} + ')'">ìƒì„¸ë³´ê¸°</button>
                                <button class="btn btn-sm btn-success" th:onclick="'registerCase(' + ${history.id} + ')'">ì‚¬ë¡€ ë“±ë¡</button>
                                <button class="btn btn-sm btn-outline-danger" th:onclick="'deleteHistory(' + ${history.id} + ')'">ì‚­ì œ</button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">AI ì§„ë‹¨ ë³´ê³ ì„œ ìƒì„¸</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalReportContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));

    const swalCustom = Swal.mixin({
        confirmButtonColor: '#1e293b',
        cancelButtonColor: '#6c757d',
        background: '#f8f9fa'
    });

    async function showDetail(id) {
        const response = await fetch(`/api/admin/history/detail/${id}`);
        if (response.ok) {
            const data = await response.json();
            document.getElementById('modalReportContent').innerHTML = marked.parse(data.aiReport);
            reportModal.show();
        }
    }

    async function registerCase(id) {
        const result = await swalCustom.fire({
            title: 'ì‚¬ë¡€ ë“±ë¡',
            text: 'ì´ ì§„ë‹¨ ë‚´ìš©ì„ í•´ê²° ì‚¬ë¡€ ì €ì¥ì†Œì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë“±ë¡ í›„ íˆìŠ¤í† ë¦¬ì—ì„œ ì‚­ì œë©ë‹ˆë‹¤.',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'ë“±ë¡',
            cancelButtonText: 'ì·¨ì†Œ'
        });

        if (result.isConfirmed) {
            const response = await fetch(`/api/admin/history/clone-to-resolution/${id}`, { method: 'POST' });
            if (response.ok) {
                swalCustom.fire({
                    icon: 'success',
                    title: 'ë“±ë¡ ì™„ë£Œ',
                    text: 'ì§€ì‹ ì €ì¥ì†Œì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
                    timer: 2000,
                    showConfirmButton: false
                });
                // Remove the row from DOM
                const row = document.getElementById('history-row-' + id);
                if (row) row.remove();
            } else {
                swalCustom.fire({
                    icon: 'error',
                    title: 'ë“±ë¡ ì‹¤íŒ¨',
                    text: 'ì‚¬ë¡€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                    iconColor: '#e11d48'
                });
            }
        }
    }

    async function deleteHistory(id) {
        const result = await swalCustom.fire({
            title: 'ì‚­ì œ í™•ì¸',
            text: 'íˆìŠ¤í† ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'ì‚­ì œ',
            cancelButtonText: 'ì·¨ì†Œ'
        });

        if (result.isConfirmed) {
            const response = await fetch(`/api/admin/history/${id}`, { method: 'DELETE' });
            if (response.ok) {
                const row = document.getElementById('history-row-' + id);
                if (row) row.remove();
            } else {
                swalCustom.fire({
                    icon: 'error',
                    title: 'ì‚­ì œ ì‹¤íŒ¨',
                    text: 'íˆìŠ¤í† ë¦¬ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                    iconColor: '#e11d48'
                });
            }
        }
    }
</script>
</body>
</html>
