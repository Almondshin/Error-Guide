<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ì—ëŸ¬ì½”ë“œ ê´€ë¦¬ - MOK Error Agent</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f4f7f6; font-family: 'Pretendard', sans-serif; padding-top: 70px; }
        .container { max-width: 1200px; }
        .card { border: none; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .table thead { background-color: #f8f9fa; }
        .btn-primary { background-color: #007bff; border: none; }

        /* Navigation */
        .navbar { background-color: #1e293b !important; }
        .navbar-brand, .nav-link { color: rgba(255,255,255,0.9) !important; }
        .nav-link.active { color: #fff !important; font-weight: bold; border-bottom: 2px solid #fff; }
        .nav-link:hover { color: #fff !important; }

        /* Table Column Widths */
        .col-code { width: 100px; }
        .col-step { width: 120px; }
        .col-desc { width: auto; }
        .col-msg { width: 250px; }
        .col-action { width: 150px; }

        /* Pagination Refinement */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
            margin-top: 20px;
        }
        .size-selector .btn {
            padding: 5px 15px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg fixed-top shadow-sm mb-4">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/">MOK Error Agent</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-item nav-link" href="/">ğŸ” ì‹¤ì‹œê°„ ì§„ë‹¨</a>
            <a class="nav-item nav-link active" href="/admin/management">ğŸ“– ì—ëŸ¬ì½”ë“œ ê´€ë¦¬</a>
            <a class="nav-item nav-link" href="/admin/cases">ğŸ’¡ í•´ê²° ì‚¬ë¡€ ì €ì¥ì†Œ</a>
            <a class="nav-item nav-link" href="/admin/history">ğŸ“œ ì§„ë‹¨ íˆìŠ¤í† ë¦¬</a>
        </div>
    </div>
</nav>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">ğŸ“– ì—ëŸ¬ì½”ë“œ ê´€ë¦¬</h2>
        <button class="btn btn-primary" onclick="openModal()">+ ì‹ ê·œ ì—ëŸ¬ ë“±ë¡</button>
    </div>

    <div class="card p-4">
        <div class="mb-3">
            <div class="input-group">
                <input type="text" class="form-control" id="searchBar" placeholder="ì—ëŸ¬ ì½”ë“œ ë˜ëŠ” ì„¤ëª…ìœ¼ë¡œ ê²€ìƒ‰..." onkeypress="handleSearch(event)">
                <button class="btn btn-outline-secondary" type="button" onclick="triggerSearch()">ê²€ìƒ‰</button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle" id="errorTable">
                <thead>
                    <tr>
                        <th class="col-code">ì½”ë“œ</th>
                        <th class="col-step">ë‹¨ê³„</th>
                        <th class="col-desc">ì„¤ëª…</th>
                        <th class="col-msg">ê³ ê° ë©”ì‹œì§€</th>
                        <th class="text-center col-action">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="errorBody">
                    <!-- Data populated by JS -->
                </tbody>
            </table>
        </div>

        <!-- Pagination & Size Selector -->
        <div class="pagination-container">
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0" id="pagination">
                    <!-- Pagination items populated by JS -->
                </ul>
            </nav>

            <div class="size-selector btn-group" role="group" id="sizeSelector">
                <button type="button" class="btn btn-outline-secondary" onclick="changePageSize(15)" id="size-15">15</button>
                <button type="button" class="btn btn-outline-secondary" onclick="changePageSize(30)" id="size-30">30</button>
                <button type="button" class="btn btn-outline-secondary" onclick="changePageSize(100)" id="size-100">100</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">ì—ëŸ¬ ì •ë³´ ë“±ë¡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="errorForm">
                    <input type="hidden" id="formId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">ì—ëŸ¬ ì½”ë“œ</label>
                            <input type="text" class="form-control" id="formCode" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">ì—ëŸ¬ ë ˆì´ì–´</label>
                            <select class="form-select" id="formLayer">
                                <option value="INFRASTRUCTURE">INFRASTRUCTURE</option>
                                <option value="APPLICATION">APPLICATION</option>
                                <option value="DOMAIN">DOMAIN</option>
                                <option value="TELCO">TELCO</option>
                                <option value="CRYPTO">CRYPTO</option>
                                <option value="SYSTEM">SYSTEM</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">ì‹œìŠ¤í…œ í”Œë¡œìš° ë‹¨ê³„</label>
                        <select class="form-select" id="formStep">
                            <option value="ì¸ì¦ìš”ì²­">ì¸ì¦ìš”ì²­</option>
                            <option value="ê²€ì¦ìš”ì²­">ê²€ì¦ìš”ì²­</option>
                            <option value="í† í°ìš”ì²­">í† í°ìš”ì²­</option>
                            <option value="ARSìš”ì²­">ARSìš”ì²­</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">ì—ëŸ¬ ì„¤ëª… (ìš´ì˜ìš©)</label>
                        <textarea class="form-control" id="formDescription" rows="2" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">ê³ ê° ë…¸ì¶œ ë©”ì‹œì§€</label>
                        <textarea class="form-control" id="formCustomerMessage" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="saveError()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentPage = 0;
    let pageSize = 15;
    let totalPages = 0;
    let errors = [];
    let currentQuery = '';
    const modal = new bootstrap.Modal(document.getElementById('errorModal'));
    let isEdit = false;

    const swalCustom = Swal.mixin({
        confirmButtonColor: '#1e293b',
        cancelButtonColor: '#6c757d',
        background: '#f8f9fa'
    });

    async function loadErrors(page = 0) {
        currentPage = page;
        const url = `/api/admin/errors?page=${page}&size=${pageSize}&sort=errorCode,asc${currentQuery ? '&query=' + encodeURIComponent(currentQuery) : ''}`;
        const response = await fetch(url);
        const data = await response.json();
        errors = data.content;
        totalPages = data.totalPages;
        renderTable(errors);
        renderPagination();
        updateSizeButtons();
    }

    function renderTable(data) {
        const body = document.getElementById('errorBody');
        body.innerHTML = data.map(e => `
            <tr>
                <td class="fw-bold text-primary">${e.errorCode}</td>
                <td><span class="badge bg-light text-dark border">${e.systemFlowStep}</span></td>
                <td>${e.description}</td>
                <td><small class="text-muted">${e.customerMessage || '-'}</small></td>
                <td class="text-center">
                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-sm btn-outline-secondary" onclick="editError(${e.id})">ìˆ˜ì •</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteError(${e.id}, '${e.errorCode}')">ì‚­ì œ</button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function renderPagination() {
        const pagination = document.getElementById('pagination');
        let html = '';

        // Previous
        html += `<li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="loadErrors(${currentPage - 1})">ì´ì „</a>
                 </li>`;

        // Page Numbers (Show max 5 pages around current)
        let start = Math.max(0, currentPage - 2);
        let end = Math.min(totalPages, start + 5);
        if (end - start < 5) start = Math.max(0, end - 5);

        for (let i = start; i < end; i++) {
            html += `<li class="page-item ${currentPage === i ? 'active' : ''}">
                        <a class="page-link" href="javascript:void(0)" onclick="loadErrors(${i})">${i + 1}</a>
                     </li>`;
        }

        // Next
        html += `<li class="page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="loadErrors(${currentPage + 1})">ë‹¤ìŒ</a>
                 </li>`;

        pagination.innerHTML = html;
    }

    function updateSizeButtons() {
        document.querySelectorAll('.size-selector .btn').forEach(btn => btn.classList.remove('active', 'btn-secondary'));
        document.querySelectorAll('.size-selector .btn').forEach(btn => btn.classList.add('btn-outline-secondary'));

        const activeBtn = document.getElementById(`size-${pageSize}`);
        if (activeBtn) {
            activeBtn.classList.remove('btn-outline-secondary');
            activeBtn.classList.add('active', 'btn-secondary');
        }
    }

    function changePageSize(size) {
        pageSize = size;
        loadErrors(0);
    }

    function handleSearch(event) {
        if (event.key === 'Enter') {
            triggerSearch();
        }
    }

    function triggerSearch() {
        currentQuery = document.getElementById('searchBar').value.trim();
        loadErrors(0);
    }

    function openModal() {
        isEdit = false;
        document.getElementById('modalTitle').innerText = 'ì‹ ê·œ ì—ëŸ¬ ë“±ë¡';
        document.getElementById('formId').value = '';
        document.getElementById('formCode').disabled = false;
        document.getElementById('errorForm').reset();
        modal.show();
    }

    function editError(id) {
        isEdit = true;
        const error = errors.find(e => e.id === id);
        document.getElementById('modalTitle').innerText = 'ì—ëŸ¬ ì •ë³´ ìˆ˜ì •';
        document.getElementById('formId').value = error.id;
        document.getElementById('formCode').value = error.errorCode;
        document.getElementById('formCode').disabled = false;
        document.getElementById('formLayer').value = error.errorLayer;
        document.getElementById('formStep').value = error.systemFlowStep;
        document.getElementById('formDescription').value = error.description;
        document.getElementById('formCustomerMessage').value = error.customerMessage;
        modal.show();
    }

    async function saveError() {
        const data = {
            id: document.getElementById('formId').value || null,
            errorCode: document.getElementById('formCode').value,
            errorLayer: document.getElementById('formLayer').value,
            systemFlowStep: document.getElementById('formStep').value,
            description: document.getElementById('formDescription').value,
            customerMessage: document.getElementById('formCustomerMessage').value
        };

        if (!data.errorCode || !data.description) {
            swalCustom.fire({
                icon: 'warning',
                title: 'ì…ë ¥ ì˜¤ë¥˜',
                text: 'í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'
            });
            return;
        }

        const url = isEdit ? '/api/admin/errors/update' : '/api/admin/errors/add';
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            modal.hide();
            swalCustom.fire({
                icon: 'success',
                title: 'ì €ì¥ ì™„ë£Œ',
                timer: 1500,
                showConfirmButton: false
            });
            loadErrors(currentPage);
        } else {
            swalCustom.fire({
                icon: 'error',
                title: 'ì €ì¥ ì‹¤íŒ¨',
                text: 'ì—ëŸ¬ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                iconColor: '#e11d48'
            });
        }
    }

    async function deleteError(id, code) {
        const result = await swalCustom.fire({
            title: 'ì‚­ì œ í™•ì¸',
            text: `ì—ëŸ¬ ì½”ë“œ [${code}]ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'ì‚­ì œ',
            cancelButtonText: 'ì·¨ì†Œ'
        });

        if (result.isConfirmed) {
            const response = await fetch(`/api/admin/errors/delete/${id}`, { method: 'DELETE' });
            if (response.ok) {
                swalCustom.fire({
                    icon: 'success',
                    title: 'ì‚­ì œ ì™„ë£Œ',
                    timer: 1500,
                    showConfirmButton: false
                });
                loadErrors(currentPage);
            } else {
                swalCustom.fire({
                    icon: 'error',
                    title: 'ì‚­ì œ ì‹¤íŒ¨',
                    text: 'ì—ëŸ¬ ì •ë³´ë¥¼ ì‚­ì œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                    iconColor: '#e11d48'
                });
            }
        }
    }

    loadErrors();
</script>
</body>
</html>
